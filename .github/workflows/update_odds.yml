name: Update Betting Lines

on:
  schedule:
    # Runs every hour at minute 0
    - cron: '0 * * * *'
  workflow_dispatch: # Allows you to run this manually if you want

jobs:
  update-odds:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Fetch and Merge Odds
        env:
          API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          python -c "
          import requests
          import json
          import os

          api_key = os.environ['API_KEY']
          sports = ['americanfootball_nfl', 'americanfootball_ncaaf']
          all_games = []

          for sport in sports:
              url = f'https://api.the-odds-api.com/v4/sports/{sport}/odds/?regions=us&markets=h2h,spreads,totals&oddsFormat=american&apiKey={api_key}'
              try:
                  response = requests.get(url)
                  response.raise_for_status()
                  data = response.json()
                  # Add a sport tag to each game so we know which league it is
                  for game in data:
                      game['league'] = 'NFL' if 'nfl' in sport else 'NCAA'
                  all_games.extend(data)
              except Exception as e:
                  print(f'Error fetching {sport}: {e}')

          # Save to odds.json
          with open('odds.json', 'w') as f:
              json.dump(all_games, f, indent=2)
          "

      - name: Commit and Push changes
        run: |
          git config --global user.name 'Odds-Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add odds.json
          # Only commit if the file has actually changed
          git diff --quiet && git diff --staged --quiet || (git commit -m 'Update betting lines' && git push)
