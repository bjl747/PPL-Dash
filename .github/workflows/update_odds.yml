name: Update Betting Lines

on:
  schedule:
    - cron: '0 * * * *' # Runs every hour
  workflow_dispatch: # Allows manual button click

jobs:
  update-odds:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: pip install requests

      - name: Fetch and Clean Odds
        env:
          API_KEY: ${{ secrets.ODDS_API_KEY }}
        run: |
          python -c "
          import requests
          import json
          import os
          from datetime import datetime

          # 1. SETUP
          api_key = os.environ.get('API_KEY')
          if not api_key:
              print('Error: API Key is missing! Check GitHub Secrets.')
              exit(1)
              
          # Note: The Odds API 'ncaaf' endpoint is primarily FBS.
          sports = ['americanfootball_nfl', 'americanfootball_ncaaf']
          clean_games = []

          # 2. FETCH DATA
          for sport in sports:
              url = f'https://api.the-odds-api.com/v4/sports/{sport}/odds/?regions=us&markets=spreads,totals&oddsFormat=american&apiKey={api_key}'
              try:
                  response = requests.get(url)
                  response.raise_for_status()
                  data = response.json()
                  
                  # 3. TRANSLATE DATA
                  for game in data:
                      spread_home = 'N/A'
                      spread_away = 'N/A'
                      total_val = 'N/A'

                      bookmakers = game.get('bookmakers', [])
                      if bookmakers:
                          # Prefer DraftKings, fallback to first available
                          main_bookie = next((b for b in bookmakers if b['key'] == 'draftkings'), bookmakers[0])
                          
                          # Spread
                          spread_market = next((m for m in main_bookie['markets'] if m['key'] == 'spreads'), None)
                          if spread_market:
                              for outcome in spread_market['outcomes']:
                                  point = outcome.get('point')
                                  price = outcome.get('price')
                                  # Format +/-
                                  FormattedPoint = f'+{point}' if point > 0 else f'{point}'
                                  
                                  if outcome['name'] == game['home_team']:
                                      spread_home = FormattedPoint
                                  else:
                                      spread_away = FormattedPoint

                          # Over/Under
                          total_market = next((m for m in main_bookie['markets'] if m['key'] == 'totals'), None)
                          if total_market:
                              over_outcome = next((o for o in total_market['outcomes'] if o['name'] == 'Over'), total_market['outcomes'][0])
                              total_val = str(over_outcome.get('point', 'N/A'))

                      clean_game = {
                          'raw_date': game['commence_time'], # Keep raw for sorting
                          'game_info': game.get('notes', ''), # Grabs info like 'Fiesta Bowl' if available
                          'home_team': game['home_team'],
                          'away_team': game['away_team'],
                          'spread_home': spread_home,
                          'spread_away': spread_away,
                          'over_under': total_val,
                          'league': 'NFL' if 'nfl' in sport else 'NCAAF'
                      }
                      clean_games.append(clean_game)

              except Exception as e:
                  print(f'Error fetching {sport}: {e}')

          # 4. SORT BY DATE THEN SAVE
          # Sort games by time so they appear in order
          clean_games.sort(key=lambda x: x['raw_date'])
          
          with open('odds.json', 'w') as f:
              json.dump(clean_games, f, indent=2)
          "

      - name: Commit and Push changes
        run: |
          git config --global user.name 'Odds-Bot'
          git config --global user.email 'bot@noreply.github.com'
          git add odds.json
          git diff --quiet && git diff --staged --quiet || (git commit -m 'Update betting lines data structure' && git push)
